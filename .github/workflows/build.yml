name: Build macOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Install dependencies (if using CocoaPods)
        run: |
          if [ -f "Podfile" ]; then
            sudo gem install cocoapods
            pod install
          fi

      - name: Build App (xcodebuild)
        run: |
          # 自动查找 .xcodeproj 或 .xcworkspace
          PROJECT=$(ls *.xcodeproj 2>/dev/null | head -1)
          WORKSPACE=$(ls *.xcworkspace 2>/dev/null | head -1)
          SCHEME=$(xcodebuild -list -json | python3 -c "import sys, json; d=json.load(sys.stdin); print((d.get('project',{}) or d.get('workspace',{}))['schemes'][0])")

          if [ -n "$WORKSPACE" ]; then
            xcodebuild -workspace "$WORKSPACE" -scheme "$SCHEME" -configuration Release build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
          else
            xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration Release build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
          fi

      - name: Archive build products
        uses: actions/upload-artifact@v4
        with:
          name: macOS-App-Build
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/Build/Products/Release/*.app
            build/Release/*.app
